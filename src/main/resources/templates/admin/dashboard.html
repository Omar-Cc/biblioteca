<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragmentos/layouts/admin-layout :: fullPage(
          pageTitle='Dashboard',
          pageAdditionalCss=~{::dashboardCss},
          pageContent=~{::dashboardContent},
          pageAdditionalScripts=~{::dashboardScripts}
      )}">

<head>
  <th:block th:fragment="dashboardCss">
    <!-- Chart.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
    <!-- Animate.css para animaciones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <style>
      /* Variables CSS personalizadas */
      :root {
        --dashboard-gradient-primary: linear-gradient(135deg, #2d6e7e 0%, #1e5f6f 100%);
        --dashboard-gradient-secondary: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        --dashboard-shadow-light: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        --dashboard-shadow-medium: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        --dashboard-shadow-heavy: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        --dashboard-border-radius: 1.25rem;
        --dashboard-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Layout principal */
      .dashboard-container {
        background: var(--dashboard-gradient-secondary);
        min-height: 100vh;
        padding: 1.5rem;
      }

      /* Header rediseñado */
      .dashboard-hero {
        background: var(--dashboard-gradient-primary);
        border-radius: var(--dashboard-border-radius);
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .dashboard-hero::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="1" fill="white" opacity="0.1"/><circle cx="10" cy="90" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
        z-index: 1;
      }

      .dashboard-hero-content {
        position: relative;
        z-index: 2;
        padding: 2.5rem;
      }

      .dashboard-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .dashboard-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        margin-bottom: 0;
      }

      .dashboard-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .refresh-button {
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        transition: var(--dashboard-transition);
        backdrop-filter: blur(10px);
        font-weight: 600;
      }

      .refresh-button:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        color: white;
      }

      .last-update-badge {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        backdrop-filter: blur(10px);
      }

      /* Tarjetas de métricas rediseñadas */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .metric-card {
        background: white;
        border-radius: var(--dashboard-border-radius);
        padding: 2rem;
        box-shadow: var(--dashboard-shadow-light);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: var(--dashboard-transition);
        position: relative;
        overflow: hidden;
      }

      .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--card-color, var(--bs-primary));
        border-radius: var(--dashboard-border-radius) var(--dashboard-border-radius) 0 0;
      }

      .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--dashboard-shadow-heavy);
      }

      .metric-card.users {
        --card-color: #4f46e5;
      }

      .metric-card.books {
        --card-color: #059669;
      }

      .metric-card.loans {
        --card-color: #dc2626;
      }

      .metric-card.genres {
        --card-color: #7c3aed;
      }

      .metric-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .metric-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
        background: var(--card-color, var(--bs-primary));
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }

      .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #1f2937;
        margin-bottom: 0.5rem;
        line-height: 1;
      }

      .metric-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
      }

      .metric-change {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .change-indicator {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        gap: 0.25rem;
      }

      .change-indicator.positive {
        background: #dcfce7;
        color: #166534;
      }

      .change-indicator.negative {
        background: #fef2f2;
        color: #dc2626;
      }

      .change-indicator.neutral {
        background: #f3f4f6;
        color: #6b7280;
      }

      /* Charts rediseñados */
      .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .chart-container {
        background: white;
        border-radius: var(--dashboard-border-radius);
        box-shadow: var(--dashboard-shadow-light);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .chart-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #f3f4f6;
        background: #fafafa;
      }

      .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
      }

      .chart-subtitle {
        color: #6b7280;
        font-size: 0.875rem;
      }

      .chart-body {
        padding: 2rem;
      }

      .chart-controls {
        display: flex;
        gap: 0.5rem;
      }

      .chart-control-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: var(--dashboard-transition);
      }

      .chart-control-btn.active,
      .chart-control-btn:hover {
        background: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
      }

      /* Widgets inferiores */
      .widgets-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }

      .widget {
        background: white;
        border-radius: var(--dashboard-border-radius);
        box-shadow: var(--dashboard-shadow-light);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .widget-header {
        padding: 1.5rem 2rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .widget-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
      }

      .widget-subtitle {
        color: #6b7280;
        font-size: 0.875rem;
      }

      .widget-action {
        color: var(--bs-primary);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--dashboard-transition);
      }

      .widget-action:hover {
        color: var(--bs-primary);
        transform: translateX(4px);
      }

      .widget-body {
        padding: 0 2rem 2rem;
      }

      /* Lista de actividades */
      .activity-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border-radius: 0.75rem;
        transition: var(--dashboard-transition);
        border: 1px solid transparent;
      }

      .activity-item:hover {
        background: #f8fafc;
        border-color: #e2e8f0;
      }

      .activity-avatar {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: var(--bs-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
        font-weight: 600;
        flex-shrink: 0;
      }

      .activity-content {
        flex: 1;
        min-width: 0;
      }

      .activity-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
      }

      .activity-description {
        color: #6b7280;
        font-size: 0.8125rem;
        margin-bottom: 0.5rem;
      }

      .activity-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.75rem;
        color: #9ca3af;
      }

      /* Lista de libros populares */
      .popular-books-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .popular-book-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border-radius: 0.75rem;
        transition: var(--dashboard-transition);
        border: 1px solid transparent;
      }

      .popular-book-item:hover {
        background: #f8fafc;
        border-color: #e2e8f0;
        transform: translateX(4px);
      }

      .book-rank {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--bs-success), #16a34a);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
        flex-shrink: 0;
      }

      .book-info {
        flex: 1;
        min-width: 0;
      }

      .book-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        line-height: 1.25;
      }

      .book-author {
        color: #6b7280;
        font-size: 0.75rem;
      }

      .book-stats {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .book-badge {
        background: var(--bs-primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
      }

      .empty-state-description {
        font-size: 0.875rem;
      }

      /* Floating Action Button */
      .fab-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .fab {
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--dashboard-shadow-medium);
        transition: var(--dashboard-transition);
        position: relative;
        overflow: hidden;
      }

      .fab:hover {
        transform: scale(1.1);
        box-shadow: var(--dashboard-shadow-heavy);
      }

      .fab::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
      }

      .fab:hover::before {
        left: 100%;
      }

      .fab-primary {
        background: linear-gradient(135deg, var(--bs-primary), #1e5f6f);
      }

      .fab-success {
        background: linear-gradient(135deg, var(--bs-success), #16a34a);
      }

      .fab-info {
        background: linear-gradient(135deg, var(--bs-info), #0ea5e9);
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .widgets-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .dashboard-container {
          padding: 1rem;
        }

        .dashboard-hero-content {
          padding: 2rem;
        }

        .dashboard-title {
          font-size: 2rem;
        }

        .dashboard-actions {
          margin-top: 1rem;
          justify-content: center;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .metric-card {
          padding: 1.5rem;
        }

        .metric-value {
          font-size: 2rem;
        }

        .fab-container {
          bottom: 1rem;
          right: 1rem;
        }

        .fab {
          width: 3rem;
          height: 3rem;
          font-size: 1rem;
        }
      }

      /* Animaciones personalizadas */
      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-slide-up {
        animation: slideInUp 0.6s ease-out;
      }

      @keyframes pulse {

        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }
      }

      .animate-pulse {
        animation: pulse 2s infinite;
      }

      /* Loading states */
      .loading-shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }

        100% {
          background-position: 200% 0;
        }
      }
    </style>
  </th:block>
</head>

<body>
  <div th:fragment="dashboardContent" class="dashboard-container">

    <!-- Hero Section -->
    <section class="dashboard-hero animate__animated animate__fadeInDown">
      <div class="dashboard-hero-content">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <h1 class="dashboard-title">Panel de Control</h1>
            <p class="dashboard-subtitle">
              Gestiona tu biblioteca digital de forma inteligente
            </p>
          </div>
          <div class="col-lg-4">
            <div class="dashboard-actions justify-content-lg-end">
              <a id="refreshDashboard" class="refresh-button" th:href="@{/admin/dashboard}">
                <i class="bi bi-arrow-clockwise me-2"></i>
                <span class="refresh-text">Actualizar</span>
                <div class="spinner-border spinner-border-sm d-none ms-2" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </a>
              <div class="last-update-badge">
                <i class="bi bi-clock me-1"></i>
                <span id="lastUpdate" th:text="${#temporals.format(#temporals.createNow(), 'HH:mm')}"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Métricas Principales -->
    <section class="metrics-grid">
      <div class="metric-card users animate-slide-up" style="animation-delay: 0.1s;">
        <div class="metric-header">
          <div class="metric-icon">
            <i class="bi bi-people-fill"></i>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" th:href="@{/admin/usuarios}">Ver usuarios</a></li>
              <li><a class="dropdown-item" href="#">Exportar datos</a></li>
            </ul>
          </div>
        </div>
        <div class="metric-value" th:text="${estadisticas?.totalUsuarios ?: '0'}">1,247</div>
        <div class="metric-label">Usuarios Registrados</div>
        <div class="metric-change">
          <div class="change-indicator positive" th:if="${estadisticas?.nuevosUsuariosMes > 0}">
            <i class="bi bi-arrow-up"></i>
            <span th:text="${estadisticas.nuevosUsuariosMes}">23</span>
          </div>
          <span class="text-muted small">este mes</span>
        </div>
      </div>

      <div class="metric-card books animate-slide-up" style="animation-delay: 0.2s;">
        <div class="metric-header">
          <div class="metric-icon">
            <i class="bi bi-journal-bookmark-fill"></i>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" th:href="@{/admin/obras}">Ver obras</a></li>
              <li><a class="dropdown-item" href="#">Agregar nueva</a></li>
            </ul>
          </div>
        </div>
        <div class="metric-value" th:text="${estadisticas?.totalObras ?: '0'}">8,543</div>
        <div class="metric-label">Obras Disponibles</div>
        <div class="metric-change">
          <div class="change-indicator positive" th:if="${estadisticas?.nuevasObrasMes > 0}">
            <i class="bi bi-arrow-up"></i>
            <span th:text="${estadisticas.nuevasObrasMes}">156</span>
          </div>
          <span class="text-muted small">este mes</span>
        </div>
      </div>

      <div class="metric-card loans animate-slide-up" style="animation-delay: 0.3s;">
        <div class="metric-header">
          <div class="metric-icon">
            <i class="bi bi-arrow-repeat"></i>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" th:href="@{/admin/prestamos}">Ver préstamos</a></li>
              <li><a class="dropdown-item" href="#">Nuevo préstamo</a></li>
            </ul>
          </div>
        </div>
        <div class="metric-value" th:text="${estadisticas?.totalPrestamos ?: '0'}">342</div>
        <div class="metric-label">Préstamos Activos</div>
        <div class="metric-change">
          <div class="change-indicator positive" th:if="${estadisticas?.nuevosPrestamos > 0}">
            <i class="bi bi-arrow-up"></i>
            <span th:text="${estadisticas.nuevosPrestamos}">12</span>
          </div>
          <span class="text-muted small">nuevos hoy</span>
        </div>
      </div>

      <div class="metric-card genres animate-slide-up" style="animation-delay: 0.4s;">
        <div class="metric-header">
          <div class="metric-icon">
            <i class="bi bi-tags-fill"></i>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" th:href="@{/admin/generos}">Ver géneros</a></li>
              <li><a class="dropdown-item" href="#">Agregar género</a></li>
            </ul>
          </div>
        </div>
        <div class="metric-value" th:text="${estadisticas?.totalGeneros ?: '0'}">24</div>
        <div class="metric-label">Géneros Literarios</div>
        <div class="metric-change">
          <div class="change-indicator neutral">
            <i class="bi bi-dash"></i>
            <span>Sin cambios</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="charts-grid">
      <div class="chart-container animate__animated animate__fadeInLeft">
        <div class="chart-header">
          <div>
            <h3 class="chart-title">Tendencia de Préstamos</h3>
            <p class="chart-subtitle">Evolución mensual de la actividad</p>
          </div>
          <div class="chart-controls">
            <button class="chart-control-btn active" data-period="6m">6M</button>
            <button class="chart-control-btn" data-period="12m">12M</button>
            <button class="chart-control-btn" data-period="24m">2A</button>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="loansChart" height="300"></canvas>
        </div>
      </div>

      <div class="chart-container animate__animated animate__fadeInRight">
        <div class="chart-header">
          <div>
            <h3 class="chart-title">Distribución por Género</h3>
            <p class="chart-subtitle">Popularidad de categorías</p>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="genresChart" height="300"></canvas>
        </div>
      </div>
    </section>

    <!-- Widgets Inferiores -->
    <section class="widgets-grid">
      <!-- Actividad Reciente -->
      <div class="widget animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="widget-header">
          <div>
            <h3 class="widget-title">Actividad Reciente</h3>
            <p class="widget-subtitle">Últimas acciones del sistema</p>
          </div>
          <a href="#" class="widget-action">
            Ver todas <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        <div class="widget-body">
          <div th:if="${actividades == null or actividades.empty}" class="empty-state">
            <div class="empty-state-icon">
              <i class="bi bi-activity"></i>
            </div>
            <h4 class="empty-state-title">Sin actividad reciente</h4>
            <p class="empty-state-description">Las acciones del sistema aparecerán aquí</p>
          </div>

          <div th:unless="${actividades == null or actividades.empty}" class="activity-list">
            <div th:each="actividad, iterStat : ${actividades}" th:if="${iterStat.index < 5}" class="activity-item">
              <div class="activity-avatar">
                <i class="bi bi-person-circle"></i>
              </div>
              <div class="activity-content">
                <div class="activity-title" th:text="${actividad.tipoActividad}">
                  Nuevo usuario registrado
                </div>
                <div class="activity-description" th:text="${actividad.descripcion}">
                  Se ha registrado un nuevo usuario en el sistema
                </div>
                <div class="activity-meta">
                  <span th:text="${actividad.usuario}">Admin</span>
                  <span>•</span>
                  <span
                    th:text="${actividad.tiempoRelativo ?: (#temporals.format(actividad.fechaActividad, 'dd/MM HH:mm'))}">Hace
                    2 horas</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Libros Populares -->
      <div class="widget animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
        <div class="widget-header">
          <div>
            <h3 class="widget-title">Top Libros</h3>
            <p class="widget-subtitle">Los más prestados este mes</p>
          </div>
          <a th:href="@{/admin/obras}" class="widget-action">
            Ver todos <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        <div class="widget-body">
          <div th:if="${obrasPopulares == null or obrasPopulares.empty}" class="empty-state">
            <div class="empty-state-icon">
              <i class="bi bi-book"></i>
            </div>
            <h4 class="empty-state-title">Sin datos disponibles</h4>
            <p class="empty-state-description">Los libros más populares aparecerán aquí</p>
          </div>

          <div th:unless="${obrasPopulares == null or obrasPopulares.empty}" class="popular-books-list">
            <div th:each="obra, iterStat : ${obrasPopulares}" th:if="${iterStat.index < 5}" class="popular-book-item">
              <div class="book-rank" th:text="${iterStat.index + 1}">1</div>
              <div class="book-info">
                <div class="book-title" th:text="${obra.titulo}">
                  El nombre del viento
                </div>
                <div class="book-author" th:text="${obra.autor}">
                  Patrick Rothfuss
                </div>
              </div>
              <div class="book-stats">
                <div class="book-badge" th:text="${obra.prestamos + ' préstamos'}">
                  128 préstamos
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Floating Action Buttons -->
    <div class="fab-container d-none d-lg-flex">
      <button class="fab fab-primary" data-bs-toggle="tooltip" data-bs-placement="left" title="Nueva obra">
        <i class="bi bi-plus-lg"></i>
      </button>
      <button class="fab fab-success" data-bs-toggle="tooltip" data-bs-placement="left" title="Nuevo usuario">
        <i class="bi bi-person-plus"></i>
      </button>
      <button class="fab fab-info" data-bs-toggle="tooltip" data-bs-placement="left" title="Nuevo préstamo">
        <i class="bi bi-journal-plus"></i>
      </button>
    </div>

  </div>

  <th:block th:fragment="dashboardScripts">
    <!-- Chart.js v3.9.1 (versión estable sin módulos ES6) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"
      integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script th:inline="javascript">
      // DEBUGGING: Mostrar datos en consola
      console.log('=== DASHBOARD DEBUG INFO ===');
      console.log('Estadísticas completas:', /*[[${estadisticas}]]*/null);
      console.log('Tendencia préstamos:', /*[[${estadisticas?.tendenciaPrestamos}]]*/null);
      console.log('Obras por género:', /*[[${estadisticas?.obrasPorGenero}]]*/null);
      console.log('Préstamos por mes:', /*[[${estadisticas?.prestamosPorMes}]]*/null);
      console.log('Actividades:', /*[[${actividades}]]*/null);
      console.log('Obras populares:', /*[[${obrasPopulares}]]*/null);

      // Datos del backend con más debugging
      const dashboardData = {
        // Datos para gráfico de tendencia
        tendenciaPrestamos: /*[[${estadisticas?.tendenciaPrestamos}]]*/null,

        // Datos para gráfico de géneros  
        obrasPorGenero: /*[[${estadisticas?.obrasPorGenero}]]*/null,

        // Datos legacy (mantener compatibilidad)
        loansByMonth: /*[[${estadisticas?.prestamosPorMes}]]*/null,
        booksByGenre: /*[[${estadisticas?.obrasPorGeneroJS}]]*/null
      };

      console.log('Dashboard data procesado:', dashboardData);

      // Esperar a que el DOM y Chart.js estén completamente cargados
      window.addEventListener('load', function () {
        console.log('Window loaded, verificando Chart.js...');

        // Verificar que Chart.js esté cargado con tiempo de espera
        function waitForChart() {
          if (typeof Chart === 'undefined') {
            console.log('Chart.js aún no está disponible, esperando...');
            setTimeout(waitForChart, 100);
            return;
          }

          console.log('Chart.js cargado correctamente, versión:', Chart.version);

          // Inicializar todo después de que Chart.js esté listo
          initializeDashboard();
        }

        waitForChart();
      });

      function initializeDashboard() {
        // Inicializar tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Inicializar gráficos
        try {
          initializeCharts();
        } catch (error) {
          console.error('Error inicializando gráficos:', error);
          showNotification('Error al cargar los gráficos: ' + error.message, 'error');
        }

        // Funcionalidad del botón refresh
        setupRefreshButton();

        // Configurar controles de gráficos
        setupChartControls();

        // Animaciones de entrada
        setupAnimations();
      }

      function initializeCharts() {
        console.log('Inicializando gráficos...');

        // Procesar datos de tendencia de préstamos
        let loansLabels = [];
        let loansData = [];

        if (dashboardData.tendenciaPrestamos && Array.isArray(dashboardData.tendenciaPrestamos) && dashboardData.tendenciaPrestamos.length > 0) {
          console.log('Procesando tendencia de préstamos:', dashboardData.tendenciaPrestamos);

          loansLabels = dashboardData.tendenciaPrestamos.map(item => item.etiqueta || item.nombreMes || 'Sin datos');
          loansData = dashboardData.tendenciaPrestamos.map(item => item.totalPrestamos || 0);
        } else {
          console.log('Usando datos de ejemplo para tendencia de préstamos');
          loansLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
          loansData = [12, 19, 3, 5, 2, 3, 9, 7, 8, 12, 15, 18];
        }

        console.log('Datos para gráfico de préstamos:', { labels: loansLabels, data: loansData });

        // Gráfico de préstamos
        const loansCtx = document.getElementById('loansChart');
        if (!loansCtx) {
          console.error('Canvas loansChart no encontrado');
        } else {
          new Chart(loansCtx, {
            type: 'line',
            data: {
              labels: loansLabels,
              datasets: [{
                label: 'Préstamos',
                data: loansData,
                borderColor: '#2d6e7e',
                backgroundColor: 'rgba(45, 110, 126, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#2d6e7e',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: '#f3f4f6'
                  },
                  ticks: {
                    color: '#6b7280'
                  }
                },
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    color: '#6b7280'
                  }
                }
              },
              elements: {
                point: {
                  hoverBorderWidth: 4
                }
              }
            }
          });
          console.log('Gráfico de préstamos creado exitosamente');
        }

        // Procesar datos de géneros
        let genresLabels = [];
        let genresDataValues = [];

        if (dashboardData.obrasPorGenero && Array.isArray(dashboardData.obrasPorGenero) && dashboardData.obrasPorGenero.length > 0) {
          console.log('Procesando obras por género:', dashboardData.obrasPorGenero);

          genresLabels = dashboardData.obrasPorGenero.map(item => item.genero || 'Sin género');
          genresDataValues = dashboardData.obrasPorGenero.map(item => item.totalObras || 0);
        } else if (dashboardData.booksByGenre && typeof dashboardData.booksByGenre === 'object' && Object.keys(dashboardData.booksByGenre).length > 0) {
          console.log('Usando datos legacy de géneros:', dashboardData.booksByGenre);

          genresLabels = Object.keys(dashboardData.booksByGenre);
          genresDataValues = Object.values(dashboardData.booksByGenre);
        } else {
          console.log('Usando datos de ejemplo para géneros');
          genresLabels = ['Ficción', 'No Ficción', 'Ciencia', 'Historia'];
          genresDataValues = [45, 30, 15, 10];
        }

        console.log('Datos para gráfico de géneros:', { labels: genresLabels, data: genresDataValues });

        // Gráfico de géneros
        const genresCtx = document.getElementById('genresChart');
        if (!genresCtx) {
          console.error('Canvas genresChart no encontrado');
        } else {
          new Chart(genresCtx, {
            type: 'doughnut',
            data: {
              labels: genresLabels,
              datasets: [{
                data: genresDataValues,
                backgroundColor: [
                  '#2d6e7e',
                  '#059669',
                  '#dc2626',
                  '#7c3aed',
                  '#ea580c',
                  '#f59e0b',
                  '#84cc16',
                  '#06b6d4',
                  '#ec4899',
                  '#10b981'
                ],
                borderWidth: 0,
                hoverBorderWidth: 3,
                hoverBorderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 20,
                    color: '#6b7280',
                    font: {
                      size: 12
                    }
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: ${value} obras (${percentage}%)`;
                    }
                  }
                }
              },
              cutout: '60%'
            }
          });
          console.log('Gráfico de géneros creado exitosamente');
        }

        console.log('Todos los gráficos inicializados correctamente');
      }

      function setupRefreshButton() {
        const refreshBtn = document.getElementById('refreshDashboard');
        if (!refreshBtn) return;

        const refreshText = refreshBtn.querySelector('.refresh-text');
        const spinner = refreshBtn.querySelector('.spinner-border');
        const lastUpdate = document.getElementById('lastUpdate');

        refreshBtn.addEventListener('click', function (e) {
          e.preventDefault();

          // Mostrar loading
          refreshBtn.disabled = true;
          refreshText.textContent = 'Actualizando...';
          spinner.classList.remove('d-none');

          // Hacer petición AJAX para refrescar datos
          fetch('/admin/dashboard/refresh')
            .then(response => {
              if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
              }
              return response.json();
            })
            .then(data => {
              console.log('Datos actualizados:', data);

              // Actualizar timestamp
              const now = new Date();
              lastUpdate.textContent = now.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
              });

              // Mostrar notificación
              showNotification('Datos actualizados correctamente', 'success');

              // Recargar página para mostrar nuevos datos
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            })
            .catch(error => {
              console.error('Error actualizando datos:', error);
              showNotification('Error al actualizar los datos: ' + error.message, 'error');
            })
            .finally(() => {
              refreshBtn.disabled = false;
              refreshText.textContent = 'Actualizar';
              spinner.classList.add('d-none');
            });
        });
      }

      function setupChartControls() {
        const controlButtons = document.querySelectorAll('.chart-control-btn');

        controlButtons.forEach(button => {
          button.addEventListener('click', function () {
            // Remover clase active de todos los botones
            controlButtons.forEach(btn => btn.classList.remove('active'));
            // Agregar clase active al botón clickeado
            this.classList.add('active');

            // Cambiar período
            const period = this.dataset.period;
            console.log('Cambiando período a:', period);

            // Hacer petición para obtener datos del nuevo período
            fetch(`/admin/dashboard/periodo/${period}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
              })
              .then(data => {
                console.log('Datos del período', period, ':', data);
                showNotification('Datos actualizados para período: ' + period, 'info');
                // Aquí podrías actualizar los gráficos dinámicamente sin recargar
              })
              .catch(error => {
                console.error('Error obteniendo datos del período:', error);
                showNotification('Error al cambiar período', 'error');
              });
          });
        });
      }

      function setupAnimations() {
        // Intersection Observer para animaciones
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = '1';
              entry.target.style.transform = 'translateY(0)';
            }
          });
        }, {
          threshold: 0.1
        });

        // Observar elementos animables
        document.querySelectorAll('.animate-slide-up').forEach(el => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(20px)';
          el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          observer.observe(el);
        });
      }

      function showNotification(message, type = 'info') {
        console.log('Mostrando notificación:', message, type);

        // Crear y mostrar notificación toast
        const toastHtml = `
          <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        `;

        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
          toastContainer.style.zIndex = '1055';
          document.body.appendChild(toastContainer);
        }

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = toastContainer.lastElementChild;

        // Verificar que Bootstrap esté disponible antes de crear el toast
        if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
          const toast = new bootstrap.Toast(toastElement);
          toast.show();

          toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
          });
        } else {
          // Fallback si Bootstrap no está disponible
          console.warn('Bootstrap no disponible, mostrando notificación simple');
          toastElement.style.display = 'block';
          setTimeout(() => {
            toastElement.remove();
          }, 5000);
        }
      }
    </script>
  </th:block>
</body>

</html>