<nav th:fragment="navbar" class="navbar navbar-expand-lg navbar-enhanced sticky-top shadow-lg">
  <div class="container-fluid px-3">
    <!-- Logo y marca optimizado para 1024px -->
    <a class="navbar-brand brand-enhanced d-flex align-items-center" th:href="@{/}">
      <div class="brand-icon-wrapper">
        <img th:src="@{/image/logo.png}" alt="BiblioVirtual Logo"/>
        <i class="bi bi-book-half"></i>
      </div>
      <div class="brand-text">
        <span class="brand-name">Biblio<span class="brand-accent">Virtual</span></span>
        <small class="brand-tagline d-none d-xl-block">Tu biblioteca digital</small>
      </div>
    </a>

    <!-- Menú principal -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav navigation-menu w-100 ps-lg-5">
        <li class="nav-item">
          <a class="nav-link nav-link-enhanced" th:href="@{/}" th:classappend="${activeTab == 'home' ? 'active' : ''}">
            <div class="nav-icon">
              <i class="bi bi-house-door"></i>
            </div>
            <span class="nav-text">Inicio</span>
          </a>
        </li>

        <li class="nav-item dropdown mega-dropdown">
          <a class="nav-link nav-link-enhanced dropdown-toggle" id="catalogoDropdown" role="button"
            data-bs-toggle="dropdown" aria-expanded="false" th:classappend="${activeTab == 'catalogo' ? 'active' : ''}">
            <div class="nav-icon">
              <i class="bi bi-journal-bookmark"></i>
            </div>
            <span class="nav-text">Catálogo</span>
          </a>
          <div class="dropdown-menu mega-dropdown-menu">
            <div class="mega-dropdown-content">
              <div class="row g-0">
                <div class="col-md-6">
                  <h6 class="dropdown-header">
                    <i class="bi bi-book me-2"></i>Libros
                  </h6>
                  <a class="dropdown-item mega-item" th:href="@{/catalogo}">
                    <div class="mega-item-icon bg-primary">
                      <i class="bi bi-collection"></i>
                    </div>
                    <div class="mega-item-content">
                      <span>Todo el catálogo</span>
                      <small>Explorar colección</small>
                    </div>
                  </a>
                  <a class="dropdown-item mega-item" th:href="@{/catalogo?tipo=LIBRO_FISICO}">
                    <div class="mega-item-icon bg-success">
                      <i class="bi bi-book"></i>
                    </div>
                    <div class="mega-item-content">
                      <span>Libros físicos</span>
                      <small>Ediciones impresas</small>
                    </div>
                  </a>
                  <a class="dropdown-item mega-item" th:href="@{/catalogo?tipo=LIBRO_DIGITAL}">
                    <div class="mega-item-icon bg-info">
                      <i class="bi bi-tablet"></i>
                    </div>
                    <div class="mega-item-content">
                      <span>Libros digitales</span>
                      <small>Formato electrónico</small>
                    </div>
                  </a>
                </div>
                <div class="col-md-6">
                  <h6 class="dropdown-header">
                    <i class="bi bi-images me-2"></i>Entretenimiento
                  </h6>
                  <a class="dropdown-item mega-item" th:href="@{/catalogo?tipo=MANGA_FISICO}">
                    <div class="mega-item-icon bg-danger">
                      <i class="bi bi-bookmark-star"></i>
                    </div>
                    <div class="mega-item-content">
                      <span>Manga</span>
                      <small>Cómics japoneses</small>
                    </div>
                  </a>
                  <a class="dropdown-item mega-item" th:href="@{/catalogo?tipo=COMIC_FISICO}">
                    <div class="mega-item-icon bg-secondary">
                      <i class="bi bi-lightning"></i>
                    </div>
                    <div class="mega-item-content">
                      <span>Cómics</span>
                      <small>Novelas gráficas</small>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </li>

        <li class="nav-item">
          <a class="nav-link nav-link-enhanced" th:href="@{/planes}"
            th:classappend="${activeTab == 'planes' ? 'active' : ''}">
            <div class="nav-icon">
              <i class="bi bi-stars"></i>
            </div>
            <span class="nav-text">Planes</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link nav-link-enhanced" th:href="@{/nosotros}"
            th:classappend="${activeTab == 'nosotros' ? 'active' : ''}">
            <div class="nav-icon">
              <i class="bi bi-people"></i>
            </div>
            <span class="nav-text">Nosotros</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link nav-link-enhanced" th:href="@{/contacto}"
            th:classappend="${activeTab == 'contacto' ? 'active' : ''}">
            <div class="nav-icon">
              <i class="bi bi-chat-dots"></i>
            </div>
            <span class="nav-text">Contacto</span>
          </a>
        </li>

        <li class="nav-item d-lg-none mt-3">
          <hr class="navbar-divider">
        </li>

        <li class="nav-item d-lg-none" sec:authorize="isAnonymous()">
          <a class="nav-link nav-link-enhanced" th:href="@{/login}">
            <div class="nav-icon">
              <i class="bi bi-box-arrow-in-right"></i>
            </div>
            <span class="nav-text">Ingresar</span>
          </a>
        </li>

        <li class="nav-item d-lg-none" sec:authorize="isAnonymous()">
          <a class="nav-link nav-link-enhanced" th:href="@{/registro}">
            <div class="nav-icon">
              <i class="bi bi-person-plus"></i>
            </div>
            <span class="nav-text">Registrarse</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Acciones del usuario optimizadas -->
    <div class="user-actions d-flex align-items-center">

      <!-- Botón de búsqueda unificado -->
      <button class="btn btn-nav search-toggle-btn" type="button" aria-label="Buscar" id="searchToggleBtn">
        <i class="bi bi-search"></i>
      </button>

      <!-- Notificaciones -->
      <div class="notification-wrapper" sec:authorize="isAuthenticated()">
        <button class="btn btn-nav position-relative" id="notificationBtn" aria-label="Notificaciones">
          <i class="bi bi-bell"></i>
          <span class="notification-badge" id="notificationCount">3</span>
        </button>
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-header">
            <h6 class="mb-0">Notificaciones</h6>
            <button class="btn btn-sm btn-link text-primary">Marcar como leídas</button>
          </div>
          <div class="notification-list">
            <div class="notification-item unread">
              <div class="notification-icon bg-success">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="notification-content">
                <p class="notification-text">Tu préstamo de "El Quijote" ha sido aprobado</p>
                <small class="notification-time">Hace 2 horas</small>
              </div>
            </div>
            <div class="notification-item">
              <div class="notification-icon bg-info">
                <i class="bi bi-info-circle"></i>
              </div>
              <div class="notification-content">
                <p class="notification-text">Nuevo libro disponible: "Cien años de soledad"</p>
                <small class="notification-time">Hace 1 día</small>
              </div>
            </div>
          </div>
          <div class="notification-footer">
            <a href="#" class="btn btn-sm btn-primary w-100">Ver todas</a>
          </div>
        </div>
      </div>

      <!-- Carrito -->
      <div class="cart-wrapper">
        <a class="btn btn-nav position-relative cart-btn" th:href="@{/mi-cuenta/carrito}" aria-label="Carrito">
          <i class="bi bi-cart3"></i>
          <span class="cart-badge" th:text="${carritoItems != null && carritoItems > 0 ? carritoItems : ''}"
            th:classappend="${carritoItems == null || carritoItems == 0 ? 'd-none' : ''}">0</span>
        </a>
      </div>

      <!-- Usuario no autenticado -->
      <div class="auth-buttons d-flex" sec:authorize="isAnonymous()">
        <a class="btn btn-outline-light btn-auth" th:href="@{/login}">
          <i class="bi bi-box-arrow-in-right"></i>
          <span class="auth-text">Ingresar</span>
        </a>
        <a class="btn btn-primary btn-auth" th:href="@{/registro}">
          <i class="bi bi-person-plus"></i>
          <span class="auth-text">Registrarse</span>
        </a>
      </div>

      <!-- Usuario autenticado -->
      <div class="user-menu-wrapper" sec:authorize="isAuthenticated()">
        <div class="dropdown">
          <button class="btn btn-user dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            <div class="user-avatar">
              <i class="bi bi-person-circle"></i>
            </div>
            <div class="user-info">
              <span class="user-name" th:if="${session.perfilActivoNombre}"
                th:text="${session.perfilActivoNombre}">Usuario</span>
              <span class="user-name" th:unless="${session.perfilActivoNombre}" sec:authentication="name">Usuario</span>
              <span class="user-plan" th:text="${suscripcionInfo.nombrePlan}">Premium</span>
            </div>
            <i class="bi bi-chevron-down user-chevron ms-1"></i>
          </button>

          <ul class="dropdown-menu dropdown-menu-end user-dropdown-menu" aria-labelledby="userDropdown">
            <li class="dropdown-header">
              <div class="user-header">
                <div class="user-avatar-large">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div class="user-details">
                  <strong th:if="${session.perfilActivoNombre}" th:text="${session.perfilActivoNombre}">Perfil</strong>
                  <strong th:unless="${session.perfilActivoNombre}" sec:authentication="name">Usuario</strong>
                  <small class="text-muted" th:text="${suscripcionInfo.nombrePlan}">Plan Premium</small>
                </div>
              </div>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li sec:authorize="hasRole('ROLE_ADMIN')">
              <a class="dropdown-item admin-item" th:href="@{/admin/dashboard}">
                <div class="item-icon bg-danger">
                  <i class="bi bi-speedometer2"></i>
                </div>
                <div class="item-content">
                  <span>Panel Admin</span>
                  <small>Gestionar sistema</small>
                </div>
              </a>
            </li>
            <li sec:authorize="hasRole('ROLE_ADMIN')">
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item" th:href="@{/mi-cuenta}">
                <div class="item-icon bg-primary">
                  <i class="bi bi-person"></i>
                </div>
                <div class="item-content">
                  <span>Mi Cuenta</span>
                  <small>Configuración personal</small>
                </div>
              </a>
            </li>
            <li>
              <a class="dropdown-item" th:href="@{/mi-cuenta/perfiles/seleccionar}">
                <div class="item-icon bg-indigo">
                  <i class="bi bi-people-fill"></i>
                </div>
                <div class="item-content">
                  <span>Cambiar Perfil</span>
                  <small>Seleccionar usuario activo</small>
                </div>
              </a>
            </li>
            <li>
              <a class="dropdown-item" th:href="@{/mis-prestamos}">
                <div class="item-icon bg-success">
                  <i class="bi bi-book"></i>
                </div>
                <div class="item-content">
                  <span>Mis Préstamos</span>
                  <small>Libros activos</small>
                </div>
                <span class="item-badge">2</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" th:href="@{/favoritos}">
                <div class="item-icon bg-warning">
                  <i class="bi bi-heart"></i>
                </div>
                <div class="item-content">
                  <span>Favoritos</span>
                  <small>Libros guardados</small>
                </div>
              </a>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <form th:action="@{/logout}" method="post">
                <button type="submit" class="dropdown-item logout-item">
                  <div class="item-icon bg-danger">
                    <i class="bi bi-box-arrow-right"></i>
                  </div>
                  <div class="item-content">
                    <span>Cerrar Sesión</span>
                    <small>Salir del sistema</small>
                  </div>
                </button>
              </form>
            </li>
          </ul>
        </div>
      </div>

      <!-- Botón hamburguesa -->
      <button class="navbar-toggler hamburger-menu" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>

  </div>

  <!-- Barra de búsqueda global optimizada -->
  <div class="global-search-container" id="globalSearchContainer">
    <div class="container-fluid px-3">
      <div class="search-input-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" class="search-input" name="q" placeholder="Buscar libros, autores, ISBN..."
          autocomplete="off" id="globalSearchInput">
        <button type="button" class="search-close-btn" id="globalSearchClose">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <!-- Resultados en tiempo real -->
      <div class="search-results-container" id="searchResultsContainer">
        <!-- Estado de carga -->
        <div class="search-loading" id="searchLoading" style="display: none;">
          <div class="d-flex justify-content-center p-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Buscando...</span>
            </div>
            <span class="ms-2">Buscando...</span>
          </div>
        </div>

        <!-- Resultados -->
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>
  </div>

  <style>
    /* BASE STYLES */
    .navbar-enhanced {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 0;
      transition: all 0.3s ease;
      z-index: 1030;
    }

    .navbar-enhanced.scrolled {
      padding: 0.5rem 0;
      background: rgba(26, 26, 26, 0.95) !important;
    }

    /* CONTAINER FLUID PARA MÁXIMO APROVECHAMIENTO */
    .container-fluid {
      max-width: 100%;
    }

    /* BRAND STYLES */
    .brand-enhanced {
      text-decoration: none;
      transition: transform 0.3s ease;
      flex-shrink: 0;
      margin-right: 1rem;
    }

    .brand-enhanced:hover {
      transform: scale(1.02);
    }

    .brand-icon-wrapper {
      width: 50px;
      height: 47px;
      /* Mantiene la proporción 185:175 */
      border-radius: 8px;
      /* Esquinas redondeadas en lugar de círculo */
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
      background: transparent;
      /* Sin fondo para que se vea el logo original */
    }

    /* Si el logo tiene colores específicos, usa esto */
    .brand-icon-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      background: transparent;
      /* Crear máscara para eliminar blanco */
      -webkit-mask:
        radial-gradient(circle, black 60%, transparent 70%),
        linear-gradient(45deg, black, black);
      mask:
        radial-gradient(circle, black 60%, transparent 70%),
        linear-gradient(45deg, black, black);
      -webkit-mask-composite: intersect;
      filter:
        drop-shadow(0 0 0 transparent) brightness(1.2) contrast(1.3) saturate(1.2);
      mask-composite: intersect;
    }

    .brand-icon-wrapper i {
      font-size: 1.4rem;
      color: white;
      width: 40px;
      height: 38px;
      background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Mostrar ícono solo cuando no hay imagen */
    .brand-icon-wrapper:has(img[src=""]) i,
    .brand-icon-wrapper:not(:has(img)) i {
      display: flex;
    }

    .brand-icon-wrapper:has(img:not([src=""])) i {
      display: none;
    }

    .brand-icon-wrapper img[src=""] {
      display: none;
    }

    .brand-icon-wrapper:empty::before {
      content: "";
      width: 40px;
      height: 38px;
      background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Bootstrap Icons";
      font-size: 1.4rem;
      color: white;
    }

    .brand-text {
      min-width: 0;
    }

    .brand-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      display: block;
      line-height: 1.1;
      white-space: nowrap;
    }

    .brand-accent {
      color: var(--bs-primary);
    }

    .brand-tagline {
      color: #b8b8b8;
      font-size: 0.65rem;
      margin-top: -2px;
      line-height: 1;
    }

    /* GLOBAL SEARCH CONTAINER OPTIMIZADO */
    .global-search-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1.5rem 0 0 0;
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1025;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-height: 80vh;
      overflow-y: auto;
    }

    .global-search-container.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 25px;
      padding: 0.75rem 1rem;
      gap: 0.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: 0 auto 1rem auto;
    }

    .search-icon {
      color: #666;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .search-input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 0.5rem 0;
      font-size: 1rem;
      color: #333;
      outline: none;
      min-width: 0;
    }

    .search-input::placeholder {
      color: #888;
    }

    .search-close-btn {
      background: transparent;
      border: none;
      color: #666;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.3s ease;
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-close-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #333;
    }

    /* RESULTADOS DE BÚSQUEDA */
    .search-results-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      display: none;
    }

    .search-results-container.show {
      display: block;
    }

    .search-loading {
      padding: 1rem;
      text-align: center;
      color: #666;
    }

    .search-results {
      max-height: 400px;
      overflow-y: auto;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s ease;
      gap: 0.75rem;
    }

    .search-result-item:hover {
      background: #f8f9fa;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-image {
      width: 40px;
      height: 60px;
      background: #f0f0f0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }

    .search-result-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .search-result-image i {
      color: #666;
      font-size: 1.2rem;
    }

    .search-result-content {
      flex: 1;
      min-width: 0;
    }

    .search-result-title {
      font-weight: 600;
      color: #333;
      margin: 0 0 0.25rem 0;
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .search-result-author {
      color: #666;
      font-size: 0.8rem;
      margin: 0 0 0.25rem 0;
    }

    .search-result-type {
      display: inline-block;
      background: var(--bs-primary);
      color: white;
      padding: 0.125rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .search-no-results {
      padding: 2rem 1rem;
      text-align: center;
      color: #666;
    }

    .search-no-results i {
      font-size: 2rem;
      color: #ddd;
      margin-bottom: 0.5rem;
    }

    .search-footer {
      padding: 0.75rem 1rem;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-footer-info {
      font-size: 0.8rem;
      color: #666;
    }

    .search-footer-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-search-action {
      padding: 0.375rem 0.75rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .btn-search-primary {
      background: var(--bs-primary);
      color: white;
      border: 1px solid var(--bs-primary);
    }

    .btn-search-primary:hover {
      background: var(--bs-primary-dark);
      color: white;
      transform: translateY(-1px);
    }

    .btn-search-outline {
      background: transparent;
      color: var(--bs-primary);
      border: 1px solid var(--bs-primary);
    }

    .btn-search-outline:hover {
      background: var(--bs-primary);
      color: white;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .search-input-wrapper {
        margin: 0 1rem 1rem 1rem;
      }

      .search-results-container {
        margin: 0 1rem;
      }

      .search-result-item {
        padding: 0.5rem 0.75rem;
      }

      .search-result-image {
        width: 35px;
        height: 50px;
      }

      .search-footer {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
      }

      .search-footer-actions {
        justify-content: center;
      }
    }

    /* USER ACTIONS */
    .user-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .btn-nav {
      background: transparent;
      border: 2px solid transparent;
      color: #b8b8b8;
      padding: 0.4rem;
      border-radius: 10px;
      transition: all 0.3s ease;
      position: relative;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .btn-nav:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-color: rgba(255, 255, 255, 0.2);
    }

    .search-toggle-btn.active {
      background: var(--bs-primary);
      color: white;
      border-color: var(--bs-primary);
    }

    /* NOTIFICATIONS */
    .notification-wrapper {
      position: relative;
      flex-shrink: 0;
      margin-right: 0.25rem;
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      background: var(--bs-danger);
      color: white;
      border-radius: 50%;
      font-size: 0.65rem;
      padding: 1px 4px;
      min-width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      width: 300px;
      max-height: 350px;
      display: none;
      z-index: 1000;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .notification-dropdown.show {
      display: block;
    }

    .notification-header {
      padding: 0.75rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h6 {
      font-size: 0.9rem;
    }

    .notification-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid #f8f9fa;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      transition: background 0.2s ease;
    }

    .notification-item:hover {
      background: #f8f9fa;
    }

    .notification-item.unread {
      background: rgba(var(--bs-primary-rgb), 0.05);
      border-left: 3px solid var(--bs-primary);
    }

    .notification-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-text {
      margin: 0;
      font-size: 0.8rem;
      line-height: 1.3;
      color: #333;
    }

    .notification-time {
      color: #666;
      font-size: 0.7rem;
    }

    .notification-footer {
      padding: 0.6rem 0.75rem;
      border-top: 1px solid #eee;
    }

    /* CART */
    .cart-wrapper {
      position: relative;
      flex-shrink: 0;
      margin-right: 0.25rem;
    }

    .cart-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--bs-danger);
      color: white;
      border-radius: 50%;
      font-size: 0.65rem;
      padding: 1px 4px;
      min-width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    /* AUTH BUTTONS */
    .auth-buttons {
      flex-shrink: 0;
      gap: 0.25rem;
    }

    .btn-auth {
      padding: 0.4rem 0.6rem;
      border-radius: 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
      flex-shrink: 0;
      font-size: 0.8rem;
      height: 36px;
    }

    .btn-auth:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .auth-text {
      font-size: 0.8rem;
    }

    /* USER MENU */
    .user-menu-wrapper {
      flex-shrink: 0;
    }

    .btn-user {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.4rem 0.6rem;
      border-radius: 18px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      white-space: nowrap;
      height: 45px;
      max-width: 180px;
    }

    .btn-user::after {
      display: none !important;
    }

    .btn-user:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
      transform: translateY(-1px);
    }

    .btn-user:active {
      transform: translateY(0);
    }

    .btn-user.show {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .user-avatar {
      font-size: 1.2rem;
      flex-shrink: 0;
      color: var(--bs-primary);
    }

    .user-info {
      text-align: left;
      min-width: 0;
      flex: 1;
      overflow: hidden;
    }

    .user-name {
      display: block;
      font-weight: 600;
      font-size: 0.8rem;
      line-height: 1.1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-plan {
      color: var(--bs-primary);
      font-size: 0.65rem;
      line-height: 1;
    }

    .user-chevron {
      font-size: 0.7rem;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }

    /* Rotar la flecha cuando el dropdown esté abierto */
    .dropdown.show .user-chevron {
      transform: rotate(180deg);
    }

    /* Alternativa: si usas aria-expanded */
    .btn-user[aria-expanded="true"] .user-chevron {
      transform: rotate(180deg);
    }

    /* Color adicional para íconos */
    .bg-indigo {
      background: #6610f2;
    }

    /* USER DROPDOWN */
    .user-dropdown-menu {
      border: none;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      padding: 0.5rem 0;
      min-width: 280px;
      margin-top: 10px;
      animation: dropdownFadeIn 0.3s ease;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
    }

    .user-avatar-large {
      font-size: 1.5rem;
      color: var(--bs-primary);
    }

    .user-details strong {
      display: block;
      font-size: 0.85rem;
    }

    .user-details small {
      font-size: 0.7rem;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      transition: background 0.2s ease;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .item-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .item-content {
      flex: 1;
      min-width: 0;
    }

    .item-content span {
      display: block;
      font-weight: 500;
      color: #333;
      font-size: 0.85rem;
    }

    .item-content small {
      color: #666;
      font-size: 0.7rem;
    }

    .item-badge {
      background: var(--bs-primary);
      color: white;
      font-size: 0.65rem;
      padding: 1px 5px;
      border-radius: 8px;
      font-weight: 600;
    }

    .admin-item {
      background: rgba(var(--bs-danger-rgb), 0.05);
    }

    .logout-item {
      color: var(--bs-danger);
    }

    .logout-item:hover {
      background: rgba(var(--bs-danger-rgb), 0.05);
    }

    /* HAMBURGER */
    .hamburger-menu {
      background: transparent;
      border: none;
      padding: 0.4rem;
      width: 36px;
      height: 36px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 3px;
      border-radius: 8px;
      transition: background 0.3s ease;
      flex-shrink: 0;
    }

    .hamburger-menu:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .hamburger-line {
      width: 18px;
      height: 2px;
      background: white;
      transition: all 0.3s ease;
      border-radius: 1px;
    }

    .hamburger-menu[aria-expanded="true"] .hamburger-line:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger-menu[aria-expanded="true"] .hamburger-line:nth-child(2) {
      opacity: 0;
    }

    .hamburger-menu[aria-expanded="true"] .hamburger-line:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    /* NAVIGATION MENU */
    .navigation-menu {
      padding-top: 1rem;
    }

    .nav-link-enhanced {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      transition: all 0.3s ease;
      color: #b8b8b8;
      text-decoration: none;
      position: relative;
      margin: 0.25rem 0;
    }

    .nav-link-enhanced:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(5px);
    }

    .nav-link-enhanced.active {
      background: rgba(var(--bs-primary-rgb), 0.2);
      color: var(--bs-light) !important;
      border-left: 3px solid var(--bs-primary);
    }

    .nav-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      font-size: 1.1rem;
    }

    .navbar-divider {
      border-color: rgba(255, 255, 255, 0.2);
      margin: 0.5rem 1rem;
    }

    /* MEGA DROPDOWN */
    .mega-dropdown-menu {
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      padding: 0;
      min-width: 450px;
      margin-top: 8px;
    }

    .mega-dropdown-content {
      padding: 1rem;
    }

    .mega-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem;
      border-radius: 6px;
      transition: background 0.2s ease;
      text-decoration: none;
      color: inherit;
    }

    .mega-item:hover {
      background: #f8f9fa;
      color: inherit;
    }

    .mega-item-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .mega-item-content span {
      display: block;
      font-weight: 500;
      color: #333;
      font-size: 0.85rem;
    }

    .mega-item-content small {
      color: #666;
      font-size: 0.7rem;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .global-search-filters {
        display: none;
      }

      .global-search-btn span {
        display: none;
      }

      .auth-text {
        display: none;
      }

      .user-info {
        display: none;
      }
    }

    @media (max-width: 576px) {
      .global-search-input-group {
        padding: 0.5rem;
        gap: 0.5rem;
      }

      .global-search-btn {
        padding: 0.4rem;
      }

      .global-search-close {
        width: 32px;
        height: 32px;
      }

      .global-search-suggestions {
        width: calc(100vw - 1.5rem);
        left: -0.75rem;
      }
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      .global-search-input-group {
        background: rgba(255, 255, 255, 0.1);
      }

      .global-search-input {
        color: white;
      }

      .global-search-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .global-search-filters .form-select {
        background-color: rgba(0, 0, 0, 0.2);
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
      }

      .global-search-suggestions {
        background: #2d3748;
        color: white;
      }

      .suggestion-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .suggestion-content h6 {
        color: white;
      }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
      }
    }

    .btn-nav:focus,
    .global-search-input:focus,
    .global-search-btn:focus {
      outline: 2px solid var(--bs-primary);
      outline-offset: 2px;
    }
  </style>

  <!-- JavaScript optimizado -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchToggleBtn = document.getElementById('searchToggleBtn');
      const globalSearchContainer = document.getElementById('globalSearchContainer');
      const globalSearchInput = document.getElementById('globalSearchInput');
      const globalSearchClose = document.getElementById('globalSearchClose');
      const searchResultsContainer = document.getElementById('searchResultsContainer');
      const searchResults = document.getElementById('searchResults');
      const searchLoading = document.getElementById('searchLoading');

      let searchTimeout;
      let currentRequest;

      // Toggle búsqueda
      searchToggleBtn.addEventListener('click', toggleGlobalSearch);
      globalSearchClose.addEventListener('click', closeGlobalSearch);

      function toggleGlobalSearch() {
        if (globalSearchContainer.classList.contains('active')) {
          closeGlobalSearch();
        } else {
          openGlobalSearch();
        }
      }

      function openGlobalSearch() {
        globalSearchContainer.classList.add('active');
        searchToggleBtn.classList.add('active');
        setTimeout(() => globalSearchInput.focus(), 300);
      }

      function closeGlobalSearch() {
        globalSearchContainer.classList.remove('active');
        searchToggleBtn.classList.remove('active');
        searchResultsContainer.classList.remove('show');
        searchResults.innerHTML = '';
        globalSearchInput.value = '';
        // Cancelar búsqueda pendiente
        if (currentRequest) {
          currentRequest.abort();
        }
      }

      // Cerrar con ESC
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && globalSearchContainer.classList.contains('active')) {
          closeGlobalSearch();
        }
      });

      // Búsqueda en tiempo real
      globalSearchInput.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        // Cancelar request anterior
        if (currentRequest) {
          currentRequest.abort();
        }

        if (query.length >= 3) {
          showLoading();
          searchTimeout = setTimeout(() => {
            performRealTimeSearch(query);
          }, 300);
        } else {
          hideResults();
        }
      });

      // Envío por Enter
      globalSearchInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const query = this.value.trim();
          if (query.length >= 3) {
            window.location.href = `/buscar?q=${encodeURIComponent(query)}`;
          }
        }
      });

      function showLoading() {
        searchResultsContainer.classList.add('show');
        searchLoading.style.display = 'block';
        searchResults.innerHTML = '';
      }

      function hideResults() {
        searchResultsContainer.classList.remove('show');
        searchLoading.style.display = 'none';
        searchResults.innerHTML = '';
      }

      async function performRealTimeSearch(query) {
        try {
          const controller = new AbortController();
          currentRequest = controller;

          const response = await fetch(`/api/buscar/tiempo-real?q=${encodeURIComponent(query)}&limite=8`, {
            signal: controller.signal
          });

          if (!response.ok) throw new Error('Error en la búsqueda');

          const data = await response.json();
          currentRequest = null;

          showSearchResults(data);
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('Error en búsqueda:', error);
            showErrorMessage();
          }
        } finally {
          searchLoading.style.display = 'none';
        }
      }

      function showSearchResults(data) {
        const { resultados, total, query, tieneMs } = data;

        if (resultados.length === 0) {
          showNoResults(query);
          return;
        }

        const resultadosHtml = resultados.map(contenido => `
          <div class="search-result-item" onclick="goToDetail(${contenido.id})">
            <div class="search-result-image">
              ${contenido.portadaUrl ?
            `<img src="${contenido.portadaUrl}" alt="${contenido.obra.titulo}" loading="lazy">` :
            `<i class="bi bi-book"></i>`
          }
            </div>
            <div class="search-result-content">
              <h6 class="search-result-title">${contenido.obra.titulo}</h6>
              <p class="search-result-author">${contenido.obra.autores || 'Autor desconocido'}</p>
              <span class="search-result-type">${getTypeLabel(contenido.tipo)}</span>
            </div>
          </div>
        `).join('');

        const footerInfo = total > resultados.length ?
          `Mostrando ${resultados.length} de ${total} resultados` :
          `${total} resultado${total !== 1 ? 's' : ''}`;

        searchResults.innerHTML = `
          ${resultadosHtml}
          <div class="search-footer">
            <span class="search-footer-info">${footerInfo}</span>
            <div class="search-footer-actions">
              ${tieneMs ? `<a href="/buscar?q=${encodeURIComponent(query)}" class="btn-search-action btn-search-outline">Ver todos</a>` : ''}
              <a href="/catalogo" class="btn-search-action btn-search-primary">Explorar catálogo</a>
            </div>
          </div>
        `;

        searchResultsContainer.classList.add('show');
      }

      function showNoResults(query) {
        searchResults.innerHTML = `
          <div class="search-no-results">
            <div>
              <i class="bi bi-search"></i>
              <h6>No se encontraron resultados</h6>
              <p>No encontramos contenido para "${query}"</p>
            </div>
          </div>
          <div class="search-footer">
            <span class="search-footer-info">0 resultados</span>
            <div class="search-footer-actions">
              <a href="/catalogo" class="btn-search-action btn-search-primary">Explorar catálogo</a>
            </div>
          </div>
        `;
        searchResultsContainer.classList.add('show');
      }

      function showErrorMessage() {
        searchResults.innerHTML = `
          <div class="search-no-results">
            <div>
              <i class="bi bi-exclamation-triangle"></i>
              <h6>Error en la búsqueda</h6>
              <p>Hubo un problema al realizar la búsqueda. Intenta nuevamente.</p>
            </div>
          </div>
        `;
        searchResultsContainer.classList.add('show');
      }

      function getTypeLabel(tipo) {
        const labels = {
          'LIBRO_FISICO': 'Libro físico',
          'LIBRO_DIGITAL': 'Libro digital',
          'MANGA_FISICO': 'Manga',
          'COMIC_FISICO': 'Cómic',
          'AUDIOLIBRO': 'Audiolibro',
          'REVISTA_PERIODICA': 'Revista',
          'MATERIAL_EDUCATIVO': 'Material educativo',
          'CONTENIDO_MULTIMEDIA': 'Multimedia'
        };
        return labels[tipo] || 'Contenido';
      }

      // Función global para navegar al detalle
      window.goToDetail = function (contenidoId) {
        window.location.href = `/catalogo/contenido/${contenidoId}`;
      };

      // Cerrar resultados al hacer clic fuera
      document.addEventListener('click', function (e) {
        if (!globalSearchContainer.contains(e.target) && !searchToggleBtn.contains(e.target)) {
          if (globalSearchContainer.classList.contains('active')) {
            closeGlobalSearch();
          }
        }
      });

      // Navbar scroll effect
      const navbar = document.querySelector('.navbar-enhanced');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 100) {
          navbar.classList.add('scrolled');
        } else {
          navbar.classList.remove('scrolled');
        }
      });

      // Notification dropdown
      const notificationBtn = document.getElementById('notificationBtn');
      const notificationDropdown = document.getElementById('notificationDropdown');

      if (notificationBtn && notificationDropdown) {
        notificationBtn.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          notificationDropdown.classList.toggle('show');
        });

        document.addEventListener('click', function (e) {
          if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
            notificationDropdown.classList.remove('show');
          }
        });
      }

      // Hamburger menu
      const hamburgerBtn = document.querySelector('.hamburger-menu');
      const navbarCollapse = document.getElementById('navbarNav');

      if (hamburgerBtn && navbarCollapse) {
        navbarCollapse.addEventListener('shown.bs.collapse', function () {
          hamburgerBtn.setAttribute('aria-expanded', 'true');
        });

        navbarCollapse.addEventListener('hidden.bs.collapse', function () {
          hamburgerBtn.setAttribute('aria-expanded', 'false');
        });
      }

      // Close mobile menu on link click
      document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.addEventListener('click', function () {
          const navbarCollapse = document.getElementById('navbarNav');
          if (navbarCollapse && navbarCollapse.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(navbarCollapse);
            bsCollapse.hide();
          }
        });
      });
    });
  </script>
</nav>